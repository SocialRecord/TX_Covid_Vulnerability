import pandas as pd
import numpy as np
import os

def replace_nulls_in_df(df):
    """
    Takes in the dataframe and replaces the nulls with 0
    """
    return df.fillna(0)


def add_calculated_columns(df):
    """
    Takes in a df (without nulls) and creates multiple calculated columns based on the original numerical columns. All pct columns have been multiplied by 100 to generate numbers that people understand as pct, but if smaller numbers are desired this multiplier can be removed. If the order of columns is not satisfactory, the functions can be rearranged in the desired order.
    """
    # Calculate cases per 1k, 10k, & 100k
    df["cases_per_1k"] = round(df["num_covid_cases"] / (df["population"] / 1000), 2)
    df["cases_per_10k"] = round(df["num_covid_cases"] / (df["population"] / 10000),2)
    df["cases_per_100k"] = round(df["num_covid_cases"] / (df["population"] / 100000), 2)
    # Calculate positivity rate (cases / tests)
    df["positivity_rate"] = round(df["num_covid_cases"] / df["total_tests"],2)
    # Update population density (how many people per sq mile of land in the county)
    df["pop_density"] = round(df["population"] / df["LandAreaSQMiles2010"], 2)
    # Convert numerical columns into percents
    df["low_food_access_pct"] = round((df["LACCESS_POP15"] / df["population"]) * 100, 2)
    # of all children, what proportion live below poverty line?
    df["pov_under_18_pct"] = round((df["PovertyUnder18Num"] / df["Under18Num2010"]) * 100, 2)
    # of all population, what proportion live below poverty line?
    df["pov_pct"] = round((df["PovertyAllAgesNum"] / df["population"]) * 100, 2)
    df["senior_pct"] = round((df["Age65AndOlderNum2010"] / df["population"]) * 100, 2)
    df["children_pct"] = round((df["Under18Num2010"] / df["population"]) * 100,2)
    # of all heads of household, what proportion own their own homes? Rent?
    df["home_owner_pct"] = round((df["OwnHomeNum"] / df["TotalHH"]) * 100, 2)
    df["renter_pct"] = round((100 - df["home_owner_pct"]), 2)
    # of all heads of households, what proportion are female?
    df["female_hh_pct"] = round((df["FemaleHHNum"] / df["TotalHH"]) * 100,2)
    # of all heads of households, what proportion are over 65 and live alone?
    df["senior_hh_pct"] = round((df["HH65PlusAloneNum"] / df["TotalHH"]) * 100,2)
    # of all heads of households, what proportion do not speak english?
    df["non_english_hh_pct"] = round((df["NonEnglishHHNum"] / df["TotalHH"]) * 100, 2)
    # of the adult population, what proportion have what level of education?
    df["Ed1_pct"] = round((
        df["Ed1LessThanHSNum"] / (df["population"] - df["Under18Num2010"])
    ) * 100, 2)
    df["Ed2_pct"] = round(
        (df["Ed2HSDiplomaOnlyNum"] / (df["population"] - df["Under18Num2010"])
    ) * 100,2)
    df["Ed3_pct"] = round(
        (df["Ed3SomeCollegeNum"] / (df["population"] - df["Under18Num2010"])
    ) * 100,2)
    df["Ed4_pct"] = round(
        (df["Ed4AssocDegreeNum"] / (df["population"] - df["Under18Num2010"])
    ) * 100, 2)
    df["Ed5_pct"] = round(
        (df["Ed5CollegePlusNum"] / (df["population"] - df["Under18Num2010"])
    ) * 100,2)
    # of the population, what proportion are various races?
    df["white_pct"] = round((df["WhiteNonHispanicNum2010"] / df["population"]) * 100,2)
    df["black_pct"] = round((df["BlackNonHispanicNum2010"] / df["population"]) * 100,2)
    df["asian_pct"] = round((df["AsianNonHispanicNum2010"] / df["population"]) * 100,2)
    df["nat_am_pct"] = round((df["NativeAmericanNonHispanicNum2010"] / df["population"]) * 100,2)
    df["hispanic_pct"] = round((df["HispanicNum2010"] / df["population"]) * 100,2)
    df["multi_race_pct"] = round((df["MultipleRaceNum2010"] / df["population"]) * 100,2)
    # How does the median income for vets compare to the median income in the county?
    df["med_inc_vet_vs_civ"] = round((df["MedianVetsInc"] / df["MedianNonVetsInc"]) * 100,2)
    # What proportion of the adult population is a vet?
    df["all_vet_pct"] = round((
        df["Vets18ONum"] / (df["population"] - df["Under18Num2010"])
    ) * 100, 2)
    # What proportion of the adult population is disabled?
    df["disabled_pct"] = round((
        (df["NonVetsDisabilty"] + df["VetsDisabilty"])
        / (df["population"] - df["Under18Num2010"])
    ) * 100, 2)
    # What proportion of the vet population is poor?
    df["poor_vets_pct"] = round((df["VetsPoor"] / df["Vets18ONum"]) * 100,2)
    
    return df

def capitalize_county(df):
    '''
    Takes in the merged dataframe and returns it with 
    the county names capitalized
    '''
    df['County'] = df.County.str.title()
    return df

def fix_data_types(df):
    '''
    Takes in the merged dataframe and casts the necessary columns to ints
    and rounds all percent columns to two decimal places
    '''
    # specify columns to be rounded
    cols_to_round = ['cases_per_1k', 'cases_per_10k', 'cases_per_100k', 'positivity_rate', 'pop_density',
        'low_food_access_pct', 'pov_under_18_pct', 'pov_pct', 'senior_pct', 'children_pct',
        'home_owner_pct', 'renter_pct', 'female_hh_pct', 'senior_hh_pct', 'non_english_hh_pct',
        'Ed1_pct', 'Ed2_pct', 'Ed3_pct', 'Ed4_pct', 'Ed5_pct', 'white_pct', 'black_pct', 
        'asian_pct', 'nat_am_pct', 'hispanic_pct', 'multi_race_pct',
        'med_inc_vet_vs_civ', 'all_vet_pct', 'disabled_pct', 'poor_vets_pct']
    
    # round the columns
    df[cols_to_round] = df[cols_to_round].round(2)

    # specify columns to change to integers
    cols_to_int = ['MedHHInc', 'PovertyUnder18Num', 'PovertyAllAgesNum', 'LandAreaSQMiles2010', 'TotalPopEst2018',
               'NaturalChange1018', 'MedianVetsInc', 'MedianNonVetsInc', 'Vets18ONum', 
               'CLFVets18to64Num', 'NonVetsDisabilty', 'VetsDisabilty', 'NonVetsPoor', 'VetsPoor', 
               'NumCivLaborforce2018', 'RuralUrbanContinuumCode2013',
               'UrbanInfluenceCode2013', 'Metro2013', 'Micropolitan2013', 'Type_2015_Farming_NO', 
               'Type_2015_Manufacturing_NO', 'Type_2015_Mining_NO', 'Type_2015_Government_NO', 
               'Type_2015_Recreation_NO', 'Low_Employment_2015_update', 'Population_loss_2015_update', 
               'Retirement_Destination_2015_Update', 'HiAmenity', 'Metro_Adjacent2013', 'num_hospitals', 
               'num_nursing_homes']
    # cast the columns to an integer
    df[cols_to_int] = df[cols_to_int].astype(int)

    return df


def create_population_density_category_column(df):
    """Takes in dataframe and returns a new column with population 
    density grouped into 3 categories:
    Low - This will be all the counties that have a population density that are in the bottom 25%
    High - This will be all the counties that have a population density that are in the top 25%
    Mid - These will be the remaining counties
    """
    pop_density_bin_labels = ["low", "mid", "high"]
    df["pop_density_category"] = pd.qcut(df["pop_density"],
                                         q=[0, .25, .75, 1],
                                         labels=pop_density_bin_labels)
    return df


def create_infection_pct_category_column(df):
    """Takes in dataframe and returns a new column with infection rate grouped into 3 categories:
    Low - This will be all the counties that have a Infection percentage that are in the bottom 25%
    High - This will be all the counties that have a Infection percentage that are in the top 25%
    Mid - These will be the remaining counties
    """
    infection_pct_bin_labels = ["low", "mid", "high"]
    df["infection_pct_category"] = pd.qcut(df["infection_pct"],
                                           q=[0, .25, .75, 1],
                                           labels=infection_pct_bin_labels)
    return df


def prep_dataframe(df):
    '''
    Takes in the merged dataframe
    replaces nulls, adds calculated columns, capitolizes county names,
    creates pop density categories and infection percent categories,
    and adjusts data types. Then writes the dataframe to a csv.
    '''
    df = replace_nulls_in_df(df)
    df = add_calculated_columns(df)
    df = capitalize_county(df)
    df = create_population_density_category_column(df)
    df = create_infection_pct_category_column(df)
    df = fix_data_types(df)

    # write data frame to csv for later use

    df.to_csv('../Data/mother_frame.csv')

    return df


def get_data():
    df = acquire.merge_dataframes()
    df = prep_dataframe(df)
    
    return df